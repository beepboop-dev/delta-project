const express = require('express');
const cors = require('cors');
const Stripe = require('stripe');
const path = require('path');
const crypto = require('crypto');
const multer = require('multer');
const fs = require('fs');
const { v4: uuidv4 } = require('uuid');

const app = express();
const PORT = process.env.PORT || 3400;
const stripe = Stripe(process.env.STRIPE_SECRET_KEY || '');
const STRIPE_PK = process.env.STRIPE_PK || '';
const DOMAIN = process.env.DOMAIN || 'https://delta.abapture.ai';

app.use(cors());
app.use(express.json({ limit: '5mb' }));
app.use(express.static(path.join(__dirname, 'public')));

const upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 10 * 1024 * 1024 } });

// ========== IN-MEMORY STORES ==========
const usage = new Map();
const sharedResults = new Map();
const users = new Map(); // email -> { id, email, passwordHash, analyses: [] }
const sessions = new Map(); // token -> { userId, expires }

function getUsage(ip) {
  const now = new Date().toDateString();
  const entry = usage.get(ip);
  if (!entry || entry.date !== now) { usage.set(ip, { date: now, count: 0 }); return usage.get(ip); }
  return entry;
}

// ========== AUTH MIDDLEWARE ==========
function optionalAuth(req, res, next) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (token && sessions.has(token)) {
    const sess = sessions.get(token);
    if (sess.expires > Date.now()) {
      req.userId = sess.userId;
      req.user = [...users.values()].find(u => u.id === sess.userId);
    }
  }
  next();
}

// ========== RED FLAG PATTERNS (30+) ==========
const RED_FLAG_PATTERNS = [
  { id: 'unlimited_liability', name: 'Unlimited Liability', severity: 'high', patterns: [/unlimited liability/i, /shall be liable for all/i, /liability shall not be (limited|capped)/i, /without limitation/i], description: 'No cap on financial liability â€” could expose you to unlimited damages.' },
  { id: 'rights_waiver', name: 'Rights Waiver', severity: 'high', patterns: [/waive(s)? (any |all )?rights?/i, /surrender(s)? (any |all )?rights?/i, /relinquish(es)? (any |all )?rights?/i, /forfeit(s)? (any |all )?rights?/i], description: 'You may be giving up important legal rights.' },
  { id: 'unilateral_modification', name: 'Unilateral Modification', severity: 'high', patterns: [/may (modify|change|alter|amend|update) (this|the) (agreement|contract|terms)/i, /reserves? the right to (modify|change|alter|amend)/i, /at (its|our|their) sole discretion/i, /without (prior )?notice/i], description: 'The other party can change terms without your consent.' },
  { id: 'auto_renewal', name: 'Auto-Renewal Trap', severity: 'medium', patterns: [/auto(matically)?[- ]renew/i, /shall (automatically )?renew/i, /renewal period/i, /unless (written )?notice.{0,30}(days?|months?)/i], description: 'Contract auto-renews â€” you may be locked in if you miss the cancellation window.' },
  { id: 'non_compete', name: 'Non-Compete Clause', severity: 'high', patterns: [/non[- ]?compete/i, /shall not (compete|engage in|work for)/i, /covenant not to compete/i, /restrictive covenant/i, /competitive activit/i], description: 'Restricts your ability to work in your field after the contract ends.' },
  { id: 'non_solicit', name: 'Non-Solicitation', severity: 'medium', patterns: [/non[- ]?solicit/i, /shall not (solicit|recruit|hire|entice)/i, /refrain from soliciting/i], description: 'Prevents you from contacting clients or hiring employees from the other party.' },
  { id: 'arbitration', name: 'Mandatory Arbitration', severity: 'medium', patterns: [/binding arbitration/i, /mandatory arbitration/i, /shall be (resolved|settled) (by|through) arbitration/i, /waive.{0,20}(right to|jury) trial/i, /class action waiver/i], description: 'Disputes must go through arbitration â€” you lose the right to sue in court.' },
  { id: 'indemnification', name: 'Broad Indemnification', severity: 'high', patterns: [/indemnif(y|ies|ication)/i, /hold harmless/i, /defend and indemnify/i], description: 'You may be required to cover the other party\'s legal costs and damages.' },
  { id: 'termination_without_cause', name: 'Termination Without Cause', severity: 'medium', patterns: [/terminat(e|ion) (without|for no) cause/i, /terminat(e|ion) at (any time|will|its sole)/i, /immediately terminat/i, /terminat(e|ion) (with|upon) (\d+|thirty|sixty|ninety) days?' notice/i], description: 'The other party can end the contract at any time without reason.' },
  { id: 'penalty_clause', name: 'Penalty Clauses', severity: 'high', patterns: [/liquidated damages/i, /penalty (of|for|clause)/i, /early termination fee/i, /breakage fee/i, /shall pay.{0,30}(penalty|fee|damages)/i], description: 'Financial penalties for breaking the contract.' },
  { id: 'ip_assignment', name: 'IP Assignment', severity: 'high', patterns: [/assign(s|ment)?.{0,30}(intellectual property|IP|copyright|patent|trademark)/i, /work(s)?[- ]?(made)?[- ]?for[- ]?hire/i, /all (work|materials|deliverables).{0,30}(belong|property of|owned by)/i, /hereby assign/i, /transfer(s)? (all |any )?(right|title|interest)/i], description: 'You may be signing away ownership of your work or ideas.' },
  { id: 'non_disparagement', name: 'Non-Disparagement', severity: 'medium', patterns: [/non[- ]?disparagement/i, /shall not (make|publish|communicate).{0,30}(negative|disparaging|derogatory)/i, /refrain from.{0,20}(negative|disparaging|critical)/i, /not (criticize|disparage)/i], description: 'Prevents you from making negative public statements about the other party.' },
  { id: 'moonlighting_restriction', name: 'Moonlighting Restriction', severity: 'medium', patterns: [/outside (employment|work|activities)/i, /devote.{0,20}(full|entire|exclusive).{0,20}(time|attention|effort)/i, /shall not (engage in|perform|undertake).{0,30}(other|outside|additional)/i, /exclusiv(e|ity) (of service|engagement)/i, /moonlight/i], description: 'Restricts your ability to do other work or side projects.' },
  { id: 'confidentiality_overbroad', name: 'Overbroad Confidentiality', severity: 'medium', patterns: [/all (information|materials|data).{0,30}confidential/i, /perpetual(ly)? confidential/i, /survive(s)? (termination|expiration).{0,30}(indefinitely|perpetual|forever)/i, /in perpetuity/i], description: 'Confidentiality obligations that are too broad or last forever.' },
  { id: 'governing_law', name: 'Unfavorable Jurisdiction', severity: 'low', patterns: [/govern(ed|ing) (by the )?law(s)? of/i, /jurisdiction of the courts of/i, /exclusive (jurisdiction|venue)/i, /submit to the jurisdiction/i], description: 'Disputes may need to be resolved in an inconvenient location.' },
  { id: 'severability_missing', name: 'Missing Severability', severity: 'low', patterns: [], description: 'No severability clause â€” if one part is invalid, the whole contract could fail.' },
  { id: 'data_rights', name: 'Data Rights Grab', severity: 'high', patterns: [/irrevocable.{0,20}license/i, /perpetual.{0,20}license/i, /royalty[- ]?free.{0,20}license/i, /right to (use|sell|share|transfer).{0,20}(data|information|content)/i, /we (may|can|will) (use|sell|share)/i], description: 'The other party gets broad rights to use your data.' },
  { id: 'force_majeure', name: 'One-Sided Force Majeure', severity: 'medium', patterns: [/force majeure/i, /act(s)? of god/i, /beyond.{0,20}(reasonable )?control/i], description: 'Force majeure clause may only protect one party.' },
  { id: 'late_payment', name: 'Late Payment Terms', severity: 'medium', patterns: [/late (payment )?fee/i, /interest (on|at).{0,20}(overdue|late|unpaid)/i, /net[- ]?(30|45|60|90)/i, /payment.{0,30}(within|due in) (60|90|120)/i], description: 'Payment terms may be unfavorable â€” long delays or steep late fees.' },
  { id: 'entire_agreement', name: 'Entire Agreement (Merger)', severity: 'low', patterns: [/entire agreement/i, /supersedes? (all )?prior/i, /merger clause/i], description: 'This overrides all previous agreements and verbal promises.' },
  { id: 'assignment_restriction', name: 'Assignment Restriction', severity: 'low', patterns: [/may not (assign|transfer|delegate)/i, /shall not (assign|transfer)/i, /consent.{0,20}(required|necessary).{0,20}assign/i], description: 'You cannot transfer your rights under this contract.' },
  { id: 'warranty_disclaimer', name: 'Warranty Disclaimer', severity: 'medium', patterns: [/as[- ]?is/i, /without warranty/i, /disclaims? (all |any )?(warranties|warranty)/i, /no (warranties|warranty|guarantee)/i], description: 'The other party provides no guarantees about their product/service.' },
  { id: 'limitation_of_remedy', name: 'Limitation of Remedy', severity: 'medium', patterns: [/sole (and exclusive )?remedy/i, /exclusive remedy/i, /maximum (aggregate )?liability.{0,30}shall not exceed/i, /in no event.{0,20}(exceed|liable)/i], description: 'Your legal remedies may be severely limited.' },
  { id: 'survival_clause', name: 'Broad Survival Clause', severity: 'low', patterns: [/shall survive (termination|expiration)/i, /survive(s)? the (termination|expiration)/i, /obligations.{0,30}survive/i], description: 'Some obligations continue even after the contract ends.' },
  { id: 'personal_guarantee', name: 'Personal Guarantee', severity: 'high', patterns: [/personal(ly)? guarantee/i, /individual(ly)? liable/i, /jointly and severally/i, /personal liability/i], description: 'You\'re personally liable, not just your business.' },
  { id: 'automatic_price_increase', name: 'Automatic Price Increase', severity: 'medium', patterns: [/price.{0,20}increase/i, /rate.{0,20}increase/i, /escalat(e|ion)/i, /cost of living adjustment/i, /CPI adjustment/i, /annual increase/i], description: 'Prices may increase automatically over time.' },
  { id: 'no_cure_period', name: 'No Cure Period', severity: 'medium', patterns: [/immediate(ly)? terminat/i, /without.{0,20}(opportunity|right) to cure/i], description: 'No chance to fix a breach before the contract is terminated.' },
  { id: 'venue_selection', name: 'Venue Selection Clause', severity: 'low', patterns: [/exclusive venue/i, /venue shall be/i, /brought (only )?in the courts/i], description: 'Lawsuits must be filed in a specific location.' },
  { id: 'clawback', name: 'Clawback Provision', severity: 'high', patterns: [/clawback/i, /repay(ment)?.{0,30}(bonus|commission|payment)/i, /return.{0,30}(payment|compensation|bonus)/i, /refund.{0,30}(all|any) (payments|fees|amounts)/i], description: 'The other party can take back money already paid to you.' },
  { id: 'moral_rights_waiver', name: 'Moral Rights Waiver', severity: 'medium', patterns: [/moral rights/i, /waive.{0,30}moral/i, /attribution/i], description: 'You waive the right to be credited for your work.' },
];

// ========== DOCUMENT TYPE DETECTION ==========
function detectDocumentType(text) {
  const lower = text.toLowerCase();
  const scores = {
    nda: 0, lease: 0, employment: 0, freelance: 0, tos: 0,
    loan: 0, partnership: 0, purchase: 0, service: 0, saas: 0, licensing: 0
  };

  if (/non[- ]?disclosure|nda|confidential(ity)? agreement/i.test(lower)) scores.nda += 10;
  if (/disclosing party|receiving party|confidential information/i.test(lower)) scores.nda += 5;

  if (/lease|landlord|tenant|premises|rent|security deposit/i.test(lower)) scores.lease += 10;
  if (/month[- ]?to[- ]?month|occupancy|habitable|evict/i.test(lower)) scores.lease += 5;

  if (/employ(ee|er|ment)|salary|compensation|benefits|401k|pto|paid time off/i.test(lower)) scores.employment += 10;
  if (/at[- ]?will|termination of employment|job (title|duties|description)/i.test(lower)) scores.employment += 5;

  if (/freelance|independent contractor|contractor|scope of work|deliverables/i.test(lower)) scores.freelance += 10;
  if (/project (fee|rate)|milestone|invoice|1099/i.test(lower)) scores.freelance += 5;

  if (/terms of (service|use)|user agreement|acceptable use/i.test(lower)) scores.tos += 10;
  if (/account.{0,20}(terminat|suspend)|content.{0,20}policy|privacy/i.test(lower)) scores.tos += 5;

  if (/loan|principal|interest rate|repayment|borrow/i.test(lower)) scores.loan += 10;
  if (/promissory note|collateral|default|maturity date/i.test(lower)) scores.loan += 5;

  if (/partnership|partner(s)?|profit sharing|joint venture/i.test(lower)) scores.partnership += 10;

  if (/purchase (agreement|order)|buyer|seller|goods|shipping/i.test(lower)) scores.purchase += 10;

  if (/service (agreement|contract)|service provider|client/i.test(lower)) scores.service += 8;
  if (/scope of services|service level|SLA/i.test(lower)) scores.service += 5;

  if (/subscription|SaaS|software as a service|cloud/i.test(lower)) scores.saas += 10;

  if (/licens(e|or|ee)|grant of license|royalt/i.test(lower)) scores.licensing += 10;

  const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  if (sorted[0][1] === 0) return { type: 'general', label: 'General Contract', confidence: 0.3 };

  const labels = {
    nda: 'Non-Disclosure Agreement (NDA)', lease: 'Lease Agreement',
    employment: 'Employment Contract', freelance: 'Freelance/Contractor Agreement',
    tos: 'Terms of Service', loan: 'Loan Agreement',
    partnership: 'Partnership Agreement', purchase: 'Purchase Agreement',
    service: 'Service Agreement', saas: 'SaaS/Subscription Agreement',
    licensing: 'Licensing Agreement'
  };

  return { type: sorted[0][0], label: labels[sorted[0][0]], confidence: Math.min(sorted[0][1] / 15, 1) };
}

// ========== ANALYSIS ENGINE ==========
function analyzeContract(text) {
  const lines = text.split('\n');
  const lower = text.toLowerCase();

  // Document type
  const docType = detectDocumentType(text);

  // Red flags
  const redFlags = [];
  for (const flag of RED_FLAG_PATTERNS) {
    for (const pattern of flag.patterns) {
      const match = text.match(pattern);
      if (match) {
        // Find the surrounding context
        const idx = text.indexOf(match[0]);
        const start = Math.max(0, idx - 80);
        const end = Math.min(text.length, idx + match[0].length + 80);
        const context = text.slice(start, end).replace(/\n/g, ' ').trim();
        redFlags.push({
          id: flag.id, name: flag.name, severity: flag.severity,
          description: flag.description,
          context: (start > 0 ? '...' : '') + context + (end < text.length ? '...' : ''),
          match: match[0]
        });
        break; // one match per flag is enough
      }
    }
  }

  // Check for missing severability
  if (!/severab/i.test(text)) {
    redFlags.push({
      id: 'severability_missing', name: 'Missing Severability Clause', severity: 'low',
      description: 'No severability clause found. If any part of this contract is found invalid, the entire contract could be voided.',
      context: '', match: ''
    });
  }

  // Extract key terms
  const keyTerms = [];
  // Money
  const moneyMatches = text.match(/\$[\d,]+(?:\.\d{2})?(?:\s*(?:per|\/)\s*(?:month|year|hour|day|week|annum|annually|project|milestone))?/g) || [];
  moneyMatches.forEach(m => keyTerms.push({ type: 'financial', value: m.trim() }));
  // Also match written amounts
  const writtenMoney = text.match(/(?:sum of|amount of|fee of|salary of|compensation of|rate of)\s+[^.;,]+/gi) || [];
  writtenMoney.forEach(m => keyTerms.push({ type: 'financial', value: m.trim() }));

  // Time periods
  const timeMatches = text.match(/\b\d+\s*(?:day|week|month|year|business day|calendar day|working day)s?\b/gi) || [];
  timeMatches.forEach(m => keyTerms.push({ type: 'duration', value: m.trim() }));

  // Percentages
  const pctMatches = text.match(/\b\d+(?:\.\d+)?%/g) || [];
  pctMatches.forEach(m => keyTerms.push({ type: 'percentage', value: m.trim() }));

  // Extract dates
  const dates = [];
  const datePatterns = [
    /(?:January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}/g,
    /\d{1,2}\/\d{1,2}\/\d{2,4}/g,
    /\d{4}-\d{2}-\d{2}/g,
  ];
  for (const dp of datePatterns) {
    const dm = text.match(dp) || [];
    dm.forEach(d => dates.push(d));
  }

  // Extract parties
  const parties = [];
  const partyPatterns = [
    /(?:between|by and between)\s+"?([^"(]+?)"?\s*\(.*?\)\s*and\s+"?([^"(]+?)"?\s*\(/i,
    /(?:between|by and between)\s+([A-Z][A-Za-z\s,.]+?)\s*(?:\(|,\s*a\s)/i,
    /"(the\s+)?company"/gi, /"(the\s+)?contractor"/gi, /"(the\s+)?client"/gi,
    /"(the\s+)?employee"/gi, /"(the\s+)?employer"/gi,
    /"(the\s+)?landlord"/gi, /"(the\s+)?tenant"/gi,
    /"(the\s+)?licensor"/gi, /"(the\s+)?licensee"/gi,
  ];
  const partyMatch = text.match(/(?:between|by and between)\s+"?([^"(\n]+?)"?\s*\(.*?\)\s*and\s+"?([^"(\n]+?)"?\s*\(/i);
  if (partyMatch) {
    parties.push(partyMatch[1].trim(), partyMatch[2].trim());
  } else {
    // Look for defined roles
    const roles = ['company', 'contractor', 'client', 'employee', 'employer', 'landlord', 'tenant', 'licensor', 'licensee', 'seller', 'buyer', 'provider', 'recipient', 'disclosing party', 'receiving party', 'service provider'];
    for (const role of roles) {
      if (new RegExp(`"?the ${role}"?`, 'i').test(text) || new RegExp(`\\("${role}"\\)`, 'i').test(text)) {
        parties.push(role.charAt(0).toUpperCase() + role.slice(1));
      }
    }
  }

  // Extract obligations
  const obligations = [];
  const obligationPatterns = [
    { pattern: /(?:shall|must|agrees? to|is required to|will)\s+([^.;]{10,80})/gi, strength: 'mandatory' },
    { pattern: /(?:should|may wish to|is encouraged to)\s+([^.;]{10,80})/gi, strength: 'recommended' },
  ];
  for (const op of obligationPatterns) {
    let m;
    while ((m = op.pattern.exec(text)) !== null) {
      const full = m[0].trim();
      if (full.length > 15 && full.length < 200) {
        obligations.push({ text: full, strength: op.strength });
      }
    }
    if (obligations.length > 25) break;
  }

  // Calculate risk score
  let riskScore = 20; // base
  for (const flag of redFlags) {
    if (flag.severity === 'high') riskScore += 12;
    else if (flag.severity === 'medium') riskScore += 6;
    else riskScore += 3;
  }
  // Adjust for document length (very short = suspicious)
  if (text.length < 500) riskScore += 10;
  // Cap at 100
  riskScore = Math.min(Math.max(riskScore, 5), 100);

  // Generate recommendations
  const recommendations = [];
  for (const flag of redFlags) {
    switch (flag.id) {
      case 'unlimited_liability':
        recommendations.push({ priority: 'high', text: 'Negotiate a liability cap (e.g., total fees paid under the contract).' }); break;
      case 'non_compete':
        recommendations.push({ priority: 'high', text: 'Narrow the non-compete: limit geographic scope, duration (max 1 year), and industry definition.' }); break;
      case 'ip_assignment':
        recommendations.push({ priority: 'high', text: 'Clarify IP ownership. Consider "license" instead of "assignment" â€” or limit to work created specifically for this project.' }); break;
      case 'arbitration':
        recommendations.push({ priority: 'medium', text: 'Consider negotiating the right to small claims court, or at minimum ensure arbitration is in a convenient location.' }); break;
      case 'auto_renewal':
        recommendations.push({ priority: 'medium', text: 'Set a calendar reminder before the renewal date. Negotiate a shorter notice period for cancellation.' }); break;
      case 'unilateral_modification':
        recommendations.push({ priority: 'high', text: 'Require mutual written consent for any changes to terms. Add "material changes require 30-day notice."' }); break;
      case 'termination_without_cause':
        recommendations.push({ priority: 'medium', text: 'Negotiate a longer notice period (60-90 days) and a "kill fee" for early termination.' }); break;
      case 'indemnification':
        recommendations.push({ priority: 'high', text: 'Make indemnification mutual. Cap indemnification obligations at the contract value.' }); break;
      case 'non_disparagement':
        recommendations.push({ priority: 'medium', text: 'Ensure non-disparagement is mutual. Carve out exceptions for truthful statements and legal proceedings.' }); break;
      case 'moonlighting_restriction':
        recommendations.push({ priority: 'medium', text: 'Negotiate to allow outside work that doesn\'t directly compete. Clarify what counts as "competing."' }); break;
      case 'personal_guarantee':
        recommendations.push({ priority: 'high', text: 'Try to remove the personal guarantee entirely, or cap it at a specific dollar amount.' }); break;
      case 'data_rights':
        recommendations.push({ priority: 'high', text: 'Limit data usage to what\'s necessary for the service. Require data deletion upon termination.' }); break;
      case 'confidentiality_overbroad':
        recommendations.push({ priority: 'medium', text: 'Define specific categories of confidential information. Set an expiration (2-5 years is standard).' }); break;
      case 'penalty_clause':
        recommendations.push({ priority: 'high', text: 'Ensure penalties are proportional to actual damages. Negotiate mutual penalty provisions.' }); break;
      case 'clawback':
        recommendations.push({ priority: 'high', text: 'Limit clawback to cases of fraud or willful misconduct. Set a time limit on clawback rights.' }); break;
      default:
        recommendations.push({ priority: flag.severity === 'high' ? 'high' : 'medium', text: `Review the ${flag.name.toLowerCase()} clause carefully. Consider consulting a lawyer.` });
    }
  }
  if (redFlags.length === 0) {
    recommendations.push({ priority: 'low', text: 'This contract looks relatively clean. Still worth having a lawyer review before signing.' });
  }

  // Unique recommendations
  const seen = new Set();
  const uniqueRecs = recommendations.filter(r => { if (seen.has(r.text)) return false; seen.add(r.text); return true; });

  return {
    documentType: docType,
    riskScore,
    riskLevel: riskScore >= 70 ? 'high' : riskScore >= 40 ? 'medium' : 'low',
    redFlags: redFlags.sort((a, b) => ({ high: 0, medium: 1, low: 2 }[a.severity] - { high: 0, medium: 1, low: 2 }[b.severity])),
    keyTerms: [...new Map(keyTerms.map(t => [t.value, t])).values()].slice(0, 20),
    dates: [...new Set(dates)].slice(0, 10),
    parties: [...new Set(parties)].slice(0, 6),
    obligations: obligations.slice(0, 20),
    recommendations: uniqueRecs,
    wordCount: text.split(/\s+/).length,
    charCount: text.length,
  };
}

// ========== COMPARE TWO CONTRACTS ==========
function compareContracts(text1, text2) {
  const a1 = analyzeContract(text1);
  const a2 = analyzeContract(text2);

  const flagsOnlyIn1 = a1.redFlags.filter(f => !a2.redFlags.find(f2 => f2.id === f.id));
  const flagsOnlyIn2 = a2.redFlags.filter(f => !a1.redFlags.find(f2 => f2.id === f.id));
  const flagsInBoth = a1.redFlags.filter(f => a2.redFlags.find(f2 => f2.id === f.id));

  return {
    contract1: a1,
    contract2: a2,
    comparison: {
      riskDifference: a2.riskScore - a1.riskScore,
      safer: a1.riskScore <= a2.riskScore ? 'contract1' : 'contract2',
      flagsOnlyInFirst: flagsOnlyIn1,
      flagsOnlyInSecond: flagsOnlyIn2,
      flagsInBoth,
      summary: generateComparisonSummary(a1, a2, flagsOnlyIn1, flagsOnlyIn2)
    }
  };
}

function generateComparisonSummary(a1, a2, only1, only2) {
  const lines = [];
  if (a1.riskScore === a2.riskScore) {
    lines.push('Both contracts have similar risk levels.');
  } else {
    const safer = a1.riskScore < a2.riskScore ? 'Contract 1' : 'Contract 2';
    const riskier = a1.riskScore < a2.riskScore ? 'Contract 2' : 'Contract 1';
    lines.push(`${safer} is safer (risk score ${Math.min(a1.riskScore, a2.riskScore)} vs ${Math.max(a1.riskScore, a2.riskScore)}).`);
  }
  if (only1.length > 0) lines.push(`Contract 1 has ${only1.length} unique risk(s): ${only1.map(f => f.name).join(', ')}.`);
  if (only2.length > 0) lines.push(`Contract 2 has ${only2.length} unique risk(s): ${only2.map(f => f.name).join(', ')}.`);
  if (a1.documentType.type !== a2.documentType.type) {
    lines.push(`Different document types: ${a1.documentType.label} vs ${a2.documentType.label}.`);
  }
  return lines;
}

// ========== SAMPLE CONTRACTS ==========
const SAMPLE_CONTRACTS = {
  nda: {
    name: 'Non-Disclosure Agreement',
    icon: 'ðŸ”’',
    description: 'Standard mutual NDA with some aggressive terms',
    text: `NON-DISCLOSURE AGREEMENT

This Non-Disclosure Agreement ("Agreement") is entered into as of January 15, 2026, by and between TechVentures Inc. ("Disclosing Party") and the undersigned individual ("Receiving Party").

1. CONFIDENTIAL INFORMATION
All information, in any form, disclosed by the Disclosing Party to the Receiving Party shall be considered confidential information, including but not limited to business plans, customer lists, financial data, technical specifications, trade secrets, and any other proprietary information.

2. OBLIGATIONS
The Receiving Party shall not disclose, publish, or otherwise reveal any Confidential Information to any third party. The Receiving Party shall use the Confidential Information solely for the purpose of evaluating a potential business relationship.

3. DURATION
This obligation of confidentiality shall survive termination of this Agreement and shall remain in effect in perpetuity.

4. NON-SOLICITATION
The Receiving Party shall not solicit, recruit, or hire any employees, contractors, or consultants of the Disclosing Party for a period of 3 years following termination of this Agreement.

5. NON-DISPARAGEMENT
The Receiving Party shall not make or publish any negative, disparaging, or derogatory statements about the Disclosing Party, its products, services, officers, or employees, whether oral or written.

6. REMEDIES
The Receiving Party acknowledges that any breach of this Agreement may cause irreparable harm and that the Disclosing Party shall be entitled to seek injunctive relief without the necessity of posting a bond, in addition to any other remedies available at law or in equity. The Receiving Party shall indemnify and hold harmless the Disclosing Party from any damages arising from breach.

7. GOVERNING LAW
This Agreement shall be governed by the laws of the State of Delaware. Any disputes shall be resolved through binding arbitration in Wilmington, Delaware.

8. ENTIRE AGREEMENT
This Agreement constitutes the entire agreement between the parties and supersedes all prior negotiations, representations, or agreements.

The Receiving Party waives any and all rights to challenge the enforceability of this Agreement.`
  },

  lease: {
    name: 'Residential Lease Agreement',
    icon: 'ðŸ ',
    description: 'Apartment lease with typical landlord-favorable terms',
    text: `RESIDENTIAL LEASE AGREEMENT

This Lease Agreement is entered into as of February 1, 2026, between Skyline Properties LLC ("Landlord") and the undersigned ("Tenant") for the premises located at 450 Oak Avenue, Apt 12B, San Francisco, CA 94102.

1. TERM
The lease term shall commence on March 1, 2026 and end on February 28, 2027. This lease shall automatically renew for successive 12-month periods unless either party provides written notice of termination at least 90 days prior to the end of the current term.

2. RENT
Monthly rent shall be $3,200 per month, due on the 1st of each month. A late payment fee of $150 shall be assessed for any payment received after the 5th of the month. Rent may be increased by the Landlord at any time during the lease term with 30 days written notice.

3. SECURITY DEPOSIT
Tenant shall pay a security deposit of $6,400 upon execution of this lease. The Landlord reserves the right to apply the security deposit to any damages, unpaid rent, or cleaning costs at its sole discretion.

4. MAINTENANCE AND REPAIRS
Tenant shall maintain the premises in good condition. Tenant shall be responsible for all repairs costing less than $500. Landlord shall have the right to enter the premises at any time for inspection, maintenance, or showing to prospective tenants without prior notice.

5. EARLY TERMINATION
Early termination fee: $6,400 (2 months' rent) plus forfeiture of security deposit. Tenant shall provide 60 days written notice.

6. PETS
No pets are permitted without prior written consent. If approved, a non-refundable pet deposit of $800 and additional monthly pet rent of $100 shall apply.

7. LIABILITY
Tenant shall indemnify and hold harmless the Landlord from any and all claims, damages, losses, and liabilities arising from Tenant's use of the premises. Landlord's liability shall not exceed the amount of rent paid in the current month.

8. GOVERNING LAW
This lease shall be governed by the laws of the State of California. Disputes shall be resolved through binding arbitration in San Francisco County. Tenant waives the right to a jury trial.

9. MODIFICATIONS
Landlord reserves the right to modify the terms of this lease at its sole discretion with 30 days written notice. Continued occupancy after notice constitutes acceptance.`
  },

  freelance: {
    name: 'Freelance Agreement',
    icon: 'ðŸ’¼',
    description: 'Client-heavy freelance contract with IP assignment',
    text: `FREELANCE SERVICES AGREEMENT

This Freelance Services Agreement ("Agreement") is entered into as of January 20, 2026, between MegaCorp Digital ("Client") and the undersigned independent contractor ("Contractor").

1. SCOPE OF WORK
Contractor shall provide web development and design services as directed by Client. Specific deliverables, timelines, and milestones shall be communicated by Client and may be modified at Client's sole discretion.

2. COMPENSATION
Client shall pay Contractor a project fee of $8,000, payable in two installments:
- $4,000 upon completion of Phase 1 (design mockups)
- $4,000 upon completion of Phase 2 (development)
Payment shall be made within 60 days of invoice receipt via bank transfer.

3. INTELLECTUAL PROPERTY
All work, materials, deliverables, code, designs, and documentation created by Contractor in connection with this Agreement shall be considered works made for hire and shall be the sole and exclusive property of Client. Contractor hereby assigns all right, title, and interest in any intellectual property created under this Agreement. Contractor waives all moral rights in the deliverables.

4. NON-COMPETE
During the term of this Agreement and for a period of 2 years following termination, Contractor shall not engage in any work or provide services to any direct competitor of Client within North America.

5. CONFIDENTIALITY
All information provided by Client is strictly confidential. This obligation shall survive termination of this Agreement indefinitely.

6. REVISIONS
Contractor shall provide unlimited revisions until Client is satisfied with the deliverables. No additional compensation shall be provided for revision work.

7. TERMINATION
Client may terminate this Agreement at any time without cause with 7 days notice. Upon termination, Contractor shall deliver all completed and in-progress work. Client shall only be obligated to pay for work completed and approved prior to termination.

8. INDEMNIFICATION
Contractor shall defend, indemnify, and hold harmless Client from any claims, damages, losses, and expenses arising from Contractor's services or breach of this Agreement.

9. LIMITATION OF LIABILITY
In no event shall Client's total liability under this Agreement exceed the amount of fees actually paid to Contractor. Client provides no warranty regarding the accuracy of project requirements.

10. OUTSIDE WORK
Contractor shall devote full and exclusive time and attention to Client's project during the term of this Agreement and shall not engage in any other freelance or employment activities without Client's prior written consent.

11. DISPUTE RESOLUTION
Any disputes shall be resolved through binding arbitration in New York, NY. Contractor waives the right to a jury trial and any class action claims.`
  },

  employment: {
    name: 'Employment Contract',
    icon: 'ðŸ‘”',
    description: 'Tech company employment agreement',
    text: `EMPLOYMENT AGREEMENT

This Employment Agreement ("Agreement") is entered into as of February 10, 2026, by and between NexGen Technologies Inc. ("Company") and the undersigned ("Employee").

1. POSITION AND DUTIES
Employee is hired as Senior Software Engineer. Employee shall report to the VP of Engineering. Employee shall perform such duties as may be assigned from time to time by the Company.

2. COMPENSATION
Base salary: $165,000 per year, paid bi-weekly. Employee shall be eligible for an annual performance bonus of up to 20% of base salary, at the Company's sole discretion. The Company may adjust compensation at any time.

3. EQUITY
Employee shall receive a stock option grant of 10,000 shares, vesting over 4 years with a 1-year cliff. The stock option agreement shall be governed by the Company's equity incentive plan, which the Company reserves the right to modify at its sole discretion.

4. BENEFITS
Employee shall be eligible for standard company benefits including health insurance, dental, vision, and 401(k) with 4% match. Company reserves the right to modify or terminate benefits at any time.

5. AT-WILL EMPLOYMENT
Employment is at-will and may be terminated by either party at any time, with or without cause, with or without notice.

6. INTELLECTUAL PROPERTY
All inventions, discoveries, ideas, improvements, and works of authorship conceived or developed by Employee during employment, whether or not during working hours, shall be the sole property of the Company. Employee hereby assigns all right, title, and interest in such intellectual property to the Company.

7. NON-COMPETE
For a period of 18 months following termination of employment, Employee shall not work for, consult with, or provide services to any competitor of the Company, defined as any company operating in the enterprise software space within the United States.

8. NON-SOLICITATION
For a period of 2 years following termination, Employee shall not solicit, recruit, or hire any employees or contractors of the Company.

9. NON-DISPARAGEMENT
Employee shall not make any negative, disparaging, or derogatory statements about the Company, its products, management, or employees, during or after employment.

10. CONFIDENTIALITY
Employee shall not disclose any confidential information during or after employment. This obligation shall survive termination indefinitely.

11. MOONLIGHTING
Employee shall devote full time and attention to Company business. Employee shall not engage in any outside employment, consulting, or business activities without prior written approval from the Company.

12. CLAWBACK
Company reserves the right to require repayment of any bonus or incentive compensation paid within the 12 months preceding termination if Employee is terminated for cause or voluntarily resigns within 12 months of receiving such compensation.

13. DISPUTE RESOLUTION
Disputes shall be resolved through binding arbitration in San Francisco, CA, under AAA rules. Employee waives the right to a jury trial and class action claims.

14. GOVERNING LAW
This Agreement shall be governed by the laws of the State of California.`
  },

  tos: {
    name: 'Terms of Service',
    icon: 'ðŸ“±',
    description: 'Mobile app Terms of Service with broad data rights',
    text: `TERMS OF SERVICE â€” DataSync Pro

Last Updated: January 1, 2026

Welcome to DataSync Pro ("Service"). By accessing or using our Service, you agree to be bound by these Terms of Service ("Terms"). If you do not agree, do not use the Service.

1. ACCEPTANCE
By creating an account, you acknowledge that you have read, understood, and agree to be bound by these Terms. We reserve the right to modify these Terms at any time at our sole discretion without prior notice. Your continued use of the Service constitutes acceptance of any changes.

2. LICENSE
We grant you a limited, non-exclusive, non-transferable, revocable license to use the Service for personal, non-commercial purposes.

3. USER CONTENT
By uploading content to DataSync Pro, you grant us a perpetual, irrevocable, worldwide, royalty-free license to use, reproduce, modify, distribute, display, and create derivative works from your content for any purpose, including commercial purposes. You waive any moral rights in your content.

4. DATA COLLECTION
We may collect, store, analyze, and share your data, including personal information, usage patterns, device information, location data, and content, with third-party partners for advertising and service improvement purposes. We may use your data in any way we see fit to improve our products and services.

5. PRIVACY
Your use of the Service is subject to our Privacy Policy. By using the Service, you consent to the collection and use of your information as described therein.

6. SERVICE AVAILABILITY
The Service is provided "as-is" and "as available" without warranty of any kind, express or implied. We do not guarantee uninterrupted, secure, or error-free operation. We may modify, suspend, or discontinue the Service at any time without notice.

7. LIMITATION OF LIABILITY
In no event shall DataSync Pro or its affiliates be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of profits, data, or goodwill. Our maximum aggregate liability shall not exceed $10.

8. INDEMNIFICATION
You agree to defend, indemnify, and hold harmless DataSync Pro, its officers, directors, employees, and agents from any claims, damages, or expenses arising from your use of the Service or violation of these Terms.

9. ACCOUNT TERMINATION
We may suspend or terminate your account at any time, for any reason, without notice. Upon termination, your right to use the Service ceases immediately. We may delete your data without liability.

10. DISPUTE RESOLUTION
All disputes shall be resolved through binding arbitration. You waive your right to participate in a class action lawsuit or class-wide arbitration.

11. GOVERNING LAW
These Terms shall be governed by the laws of the State of Delaware, without regard to conflict of law principles. Exclusive venue shall be in Wilmington, Delaware.

12. ENTIRE AGREEMENT
These Terms constitute the entire agreement between you and DataSync Pro and supersede all prior agreements.`
  },

  saas: {
    name: 'SaaS Subscription Agreement',
    icon: 'â˜ï¸',
    description: 'Cloud software subscription with vendor-favorable terms',
    text: `SAAS SUBSCRIPTION AGREEMENT

This SaaS Subscription Agreement ("Agreement") is entered into as of March 1, 2026, between CloudStack Solutions Inc. ("Provider") and the subscribing entity ("Customer").

1. SUBSCRIPTION
Customer subscribes to CloudStack Enterprise Plan at $2,499 per month. The initial subscription term is 24 months. The subscription shall automatically renew for successive 12-month periods unless Customer provides written notice of cancellation at least 120 days prior to renewal.

2. PAYMENT
All fees are non-refundable. Payment is due within 30 days of invoice. Late payments shall incur interest at 1.5% per month. Provider may increase subscription fees by up to 10% annually upon renewal without prior notice.

3. SERVICE LEVEL
Provider shall use commercially reasonable efforts to maintain 99.5% uptime. Customer's sole remedy for failure to meet the SLA shall be a service credit not to exceed 5% of monthly fees.

4. DATA
Customer retains ownership of its data. However, Provider shall have the right to use anonymized and aggregated Customer data for analytics, benchmarking, product improvement, and marketing purposes. Provider shall maintain commercially reasonable security measures.

5. INTELLECTUAL PROPERTY
All intellectual property rights in the Service, including any customizations, integrations, or configurations created for Customer, shall remain the exclusive property of Provider. Customer receives a limited license to use the Service during the subscription term.

6. LIMITATION OF LIABILITY
In no event shall Provider's aggregate liability exceed the fees paid by Customer in the 3 months preceding the claim. Provider shall not be liable for any indirect, consequential, incidental, or punitive damages, loss of data, or business interruption.

7. WARRANTY DISCLAIMER
THE SERVICE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. PROVIDER DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.

8. EARLY TERMINATION
Customer may terminate early by paying a fee equal to the remaining months on the subscription term. If Customer terminates for convenience, no refund shall be provided.

9. DATA PORTABILITY
Upon termination, Customer shall have 30 days to export its data. After 30 days, Provider may delete all Customer data without liability.

10. INDEMNIFICATION
Customer shall indemnify and hold harmless Provider from any claims arising from Customer's use of the Service or Customer's data.

11. FORCE MAJEURE
Provider shall not be liable for failure to perform due to circumstances beyond its reasonable control, including but not limited to acts of God, war, terrorism, pandemic, natural disasters, government actions, or infrastructure failures.

12. GOVERNING LAW
This Agreement shall be governed by the laws of the State of Washington. Any disputes shall be resolved through binding arbitration in Seattle, WA.`
  },

  partnership: {
    name: 'Partnership Agreement',
    icon: 'ðŸ¤',
    description: 'Business partnership with profit sharing and exit terms',
    text: `PARTNERSHIP AGREEMENT

This Partnership Agreement ("Agreement") is entered into as of January 10, 2026, by and between Alex Chen ("Partner A") and Jordan Rivera ("Partner B"), collectively referred to as the "Partners."

1. PARTNERSHIP NAME AND PURPOSE
The Partners hereby form a general partnership under the name "ChenRivera Digital Consulting" for the purpose of providing digital marketing and consulting services.

2. CAPITAL CONTRIBUTIONS
Partner A shall contribute $50,000 in cash. Partner B shall contribute $25,000 in cash and equipment valued at $25,000.

3. PROFIT AND LOSS SHARING
Profits and losses shall be shared 60% to Partner A and 40% to Partner B. Distributions shall be made quarterly, provided the partnership maintains a minimum cash reserve of $20,000.

4. MANAGEMENT
Both Partners shall have equal management authority. Major decisions (expenditures exceeding $5,000, new hires, contracts exceeding $10,000) require unanimous consent.

5. COMPENSATION
Each Partner shall receive a monthly draw of $8,000 against their share of profits. Partner A shall receive an additional management fee of $2,000 per month.

6. NON-COMPETE
During the partnership and for a period of 3 years following dissolution or withdrawal, neither Partner shall engage in any competing business within a 100-mile radius. Violation of this provision shall result in liquidated damages of $100,000.

7. CONFIDENTIALITY
All partnership information shall be kept strictly confidential during and after the partnership. This obligation shall survive termination indefinitely.

8. WITHDRAWAL
Either Partner may withdraw with 180 days written notice. The withdrawing Partner's interest shall be purchased by the remaining Partner at a price determined by an independent appraiser. Payment shall be made over 36 months at 6% interest.

9. DEATH OR DISABILITY
Upon death or permanent disability of a Partner, the remaining Partner shall purchase the deceased/disabled Partner's interest at appraised value, payable over 48 months.

10. DISPUTE RESOLUTION
Disputes shall first be submitted to mediation. If mediation fails, disputes shall be resolved through binding arbitration in Denver, Colorado. Each Partner shall bear their own legal costs.

11. INDEMNIFICATION
Each Partner shall indemnify and hold harmless the other Partner from any claims arising from their individual negligence or misconduct.

12. DISSOLUTION
The partnership shall dissolve upon mutual agreement, bankruptcy of either Partner, or by court order. Upon dissolution, assets shall be liquidated and distributed after payment of all debts and obligations.

13. GOVERNING LAW
This Agreement shall be governed by the laws of the State of Colorado. Both Partners are jointly and severally liable for partnership obligations.

14. PERSONAL GUARANTEE
Each Partner personally guarantees all partnership debts and obligations, including any loans, leases, or vendor agreements entered into by the partnership.`
  }
};

// ========== API ROUTES ==========

// Config
app.get('/api/config', (req, res) => {
  res.json({ stripePublicKey: STRIPE_PK, sampleContracts: Object.keys(SAMPLE_CONTRACTS).map(k => ({ id: k, name: SAMPLE_CONTRACTS[k].name, icon: SAMPLE_CONTRACTS[k].icon, description: SAMPLE_CONTRACTS[k].description })) });
});

// Analyze
app.post('/api/analyze', optionalAuth, (req, res) => {
  const { text } = req.body;
  if (!text || text.trim().length < 50) return res.status(400).json({ error: 'Contract text too short (minimum 50 characters).' });
  if (text.length > 100000) return res.status(400).json({ error: 'Contract text too long (max 100,000 characters).' });

  const ip = req.headers['x-forwarded-for'] || req.ip;
  const u = getUsage(ip);
  if (!req.userId && u.count >= 3) {
    return res.status(429).json({ error: 'Free limit reached (3/day). Sign up or upgrade to Pro for unlimited analyses.', upgrade: true });
  }
  if (!req.userId) u.count++;

  const result = analyzeContract(text);

  // Generate share ID
  const shareId = crypto.randomBytes(6).toString('hex');
  sharedResults.set(shareId, { analysis: result, createdAt: Date.now(), textPreview: text.slice(0, 200) });

  // Save to user account if logged in
  if (req.user) {
    req.user.analyses.unshift({
      id: uuidv4(),
      shareId,
      documentType: result.documentType.label,
      riskScore: result.riskScore,
      redFlagCount: result.redFlags.length,
      createdAt: new Date().toISOString(),
      textPreview: text.slice(0, 200),
    });
    if (req.user.analyses.length > 50) req.user.analyses = req.user.analyses.slice(0, 50);
  }

  res.json({ ...result, shareId, shareUrl: `${DOMAIN}/share/${shareId}` });
});

// Compare
app.post('/api/compare', optionalAuth, (req, res) => {
  const { text1, text2 } = req.body;
  if (!text1 || !text2) return res.status(400).json({ error: 'Both contract texts are required.' });
  if (text1.trim().length < 50 || text2.trim().length < 50) return res.status(400).json({ error: 'Each contract must be at least 50 characters.' });

  const ip = req.headers['x-forwarded-for'] || req.ip;
  const u = getUsage(ip);
  if (!req.userId && u.count >= 3) {
    return res.status(429).json({ error: 'Free limit reached. Sign up or upgrade to Pro.', upgrade: true });
  }
  if (!req.userId) u.count++;

  const result = compareContracts(text1, text2);
  res.json(result);
});

// Get sample contract
app.get('/api/samples/:id', (req, res) => {
  const sample = SAMPLE_CONTRACTS[req.params.id];
  if (!sample) return res.status(404).json({ error: 'Sample not found' });
  res.json(sample);
});

// Get all samples
app.get('/api/samples', (req, res) => {
  res.json(Object.entries(SAMPLE_CONTRACTS).map(([id, s]) => ({ id, name: s.name, icon: s.icon, description: s.description })));
});

// Share
app.get('/api/share/:id', (req, res) => {
  const data = sharedResults.get(req.params.id);
  if (!data) return res.status(404).json({ error: 'Share not found or expired' });
  res.json(data);
});

// ========== AUTH ROUTES ==========
const bcrypt = require('bcryptjs');

app.post('/api/auth/signup', async (req, res) => {
  const { email, password, name } = req.body;
  if (!email || !password) return res.status(400).json({ error: 'Email and password required.' });
  if (users.has(email.toLowerCase())) return res.status(409).json({ error: 'Email already registered.' });
  const hash = await bcrypt.hash(password, 10);
  const user = { id: uuidv4(), email: email.toLowerCase(), name: name || '', passwordHash: hash, analyses: [], createdAt: new Date().toISOString() };
  users.set(email.toLowerCase(), user);
  const token = crypto.randomBytes(32).toString('hex');
  sessions.set(token, { userId: user.id, expires: Date.now() + 30 * 24 * 60 * 60 * 1000 });
  res.json({ token, user: { id: user.id, email: user.email, name: user.name } });
});

app.post('/api/auth/login', async (req, res) => {
  const { email, password } = req.body;
  const user = users.get(email?.toLowerCase());
  if (!user || !(await bcrypt.compare(password, user.passwordHash))) {
    return res.status(401).json({ error: 'Invalid email or password.' });
  }
  const token = crypto.randomBytes(32).toString('hex');
  sessions.set(token, { userId: user.id, expires: Date.now() + 30 * 24 * 60 * 60 * 1000 });
  res.json({ token, user: { id: user.id, email: user.email, name: user.name } });
});

app.get('/api/auth/me', optionalAuth, (req, res) => {
  if (!req.user) return res.status(401).json({ error: 'Not authenticated' });
  res.json({ id: req.user.id, email: req.user.email, name: req.user.name, analyses: req.user.analyses });
});

app.post('/api/auth/logout', (req, res) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (token) sessions.delete(token);
  res.json({ ok: true });
});

// ========== PDF EXPORT ==========
app.post('/api/export-pdf', (req, res) => {
  // Generate a simple HTML-based PDF (download as HTML that prints nicely)
  const { analysis } = req.body;
  if (!analysis) return res.status(400).json({ error: 'No analysis data' });

  const riskColor = analysis.riskLevel === 'high' ? '#ef4444' : analysis.riskLevel === 'medium' ? '#f59e0b' : '#22c55e';

  const html = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>BriefPulse Contract Analysis Report</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #1a1a2e; line-height: 1.6; }
  h1 { color: #7c5cfc; border-bottom: 3px solid #7c5cfc; padding-bottom: 10px; }
  h2 { color: #374151; margin-top: 30px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
  .risk-badge { display: inline-block; background: ${riskColor}; color: white; padding: 8px 20px; border-radius: 20px; font-size: 18px; font-weight: bold; }
  .flag { padding: 12px; margin: 8px 0; border-left: 4px solid; border-radius: 4px; background: #f9fafb; }
  .flag.high { border-color: #ef4444; }
  .flag.medium { border-color: #f59e0b; }
  .flag.low { border-color: #3b82f6; }
  .flag-name { font-weight: bold; }
  .flag-severity { text-transform: uppercase; font-size: 11px; font-weight: bold; margin-left: 8px; }
  .context { font-style: italic; color: #6b7280; font-size: 13px; margin-top: 4px; }
  .rec { padding: 8px 12px; margin: 6px 0; background: #f0fdf4; border-left: 3px solid #22c55e; border-radius: 4px; }
  .rec.high { background: #fef2f2; border-color: #ef4444; }
  .rec.medium { background: #fffbeb; border-color: #f59e0b; }
  .meta { color: #6b7280; font-size: 13px; }
  .terms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; }
  .term { padding: 8px 12px; background: #f3f4f6; border-radius: 6px; font-size: 14px; }
  .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #9ca3af; font-size: 12px; text-align: center; }
  @media print { body { padding: 20px; } }
</style></head><body>
<h1>ðŸ“‹ BriefPulse Contract Analysis Report</h1>
<p class="meta">Generated: ${new Date().toLocaleString()} | Document Type: ${analysis.documentType?.label || 'Unknown'} | Words: ${analysis.wordCount?.toLocaleString() || 'N/A'}</p>

<h2>Risk Score</h2>
<p><span class="risk-badge">${analysis.riskScore}/100 â€” ${analysis.riskLevel?.toUpperCase()} RISK</span></p>

${analysis.parties?.length ? `<h2>Parties</h2><p>${analysis.parties.join(' â€¢ ')}</p>` : ''}

<h2>Red Flags (${analysis.redFlags?.length || 0})</h2>
${(analysis.redFlags || []).map(f => `<div class="flag ${f.severity}"><span class="flag-name">${f.name}</span><span class="flag-severity" style="color:${f.severity === 'high' ? '#ef4444' : f.severity === 'medium' ? '#f59e0b' : '#3b82f6'}"> ${f.severity}</span><br>${f.description}${f.context ? `<div class="context">"${f.context}"</div>` : ''}</div>`).join('\n')}

<h2>Key Terms</h2>
<div class="terms-grid">${(analysis.keyTerms || []).map(t => `<div class="term"><strong>${t.type}:</strong> ${t.value}</div>`).join('')}</div>

${analysis.dates?.length ? `<h2>Important Dates</h2><p>${analysis.dates.join(' â€¢ ')}</p>` : ''}

<h2>Recommendations</h2>
${(analysis.recommendations || []).map(r => `<div class="rec ${r.priority}">${r.text}</div>`).join('\n')}

<div class="footer">Generated by BriefPulse â€” AI Contract Analyzer | https://delta.abapture.ai<br>This analysis is for informational purposes only and does not constitute legal advice.</div>
</body></html>`;

  res.setHeader('Content-Type', 'text/html');
  res.setHeader('Content-Disposition', 'attachment; filename="briefpulse-report.html"');
  res.send(html);
});

// Stripe checkout
app.post('/api/checkout', async (req, res) => {
  try {
    const { plan } = req.body;
    const prices = {
      monthly: { amount: 2900, interval: 'month', name: 'BriefPulse Pro Monthly' },
      annual: { amount: 19900, interval: 'year', name: 'BriefPulse Pro Annual' },
    };
    const p = prices[plan] || prices.monthly;
    const session = await stripe.checkout.sessions.create({
      payment_method_types: ['card'],
      line_items: [{ price_data: { currency: 'usd', product_data: { name: p.name, description: 'Unlimited AI contract analyses' }, unit_amount: p.amount, recurring: { interval: p.interval } }, quantity: 1 }],
      mode: 'subscription',
      success_url: `${DOMAIN}?success=true`,
      cancel_url: `${DOMAIN}?canceled=true`,
    });
    res.json({ url: session.url });
  } catch (err) {
    console.error('Stripe error:', err.message);
    res.status(500).json({ error: 'Payment setup failed' });
  }
});

// File upload
app.post('/api/upload', upload.single('file'), async (req, res) => {
  if (!req.file) return res.status(400).json({ error: 'No file uploaded' });
  let text = '';
  if (req.file.mimetype === 'text/plain' || req.file.originalname.endsWith('.txt')) {
    text = req.file.buffer.toString('utf-8');
  } else if (req.file.mimetype === 'application/pdf' || req.file.originalname.endsWith('.pdf')) {
    try {
      const pdfParse = require('pdf-parse');
      const data = await pdfParse(req.file.buffer);
      text = data.text;
    } catch (e) {
      return res.status(400).json({ error: 'Could not parse PDF. Try pasting the text instead.' });
    }
  } else {
    // Try as text
    text = req.file.buffer.toString('utf-8');
  }
  if (text.trim().length < 50) return res.status(400).json({ error: 'Could not extract enough text from file.' });
  res.json({ text: text.trim() });
});

// SPA routes
app.get('/share/:id', (req, res) => res.sendFile(path.join(__dirname, 'public', 'index.html')));
app.get('/compare', (req, res) => res.sendFile(path.join(__dirname, 'public', 'index.html')));
app.get('/samples', (req, res) => res.sendFile(path.join(__dirname, 'public', 'index.html')));
app.get('/account', (req, res) => res.sendFile(path.join(__dirname, 'public', 'index.html')));

app.listen(PORT, () => console.log(`BriefPulse running on port ${PORT}`));
